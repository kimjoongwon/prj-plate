# ============================================================================
# ğŸ—ï¸ BASE STAGE: ê¸°ë³¸ í™˜ê²½ ì„¤ì •
# ============================================================================
# Node.js 22 Alpine Linux ê¸°ë°˜ ì´ë¯¸ì§€ ì‚¬ìš© (ê²½ëŸ‰í™”ëœ ë¦¬ëˆ…ìŠ¤ ë°°í¬íŒ)
FROM node:24-alpine AS base

# ğŸ“¦ PNPM ë²„ì „ì„ ì¸ìë¡œ ë°›ì•„ì„œ ì„¤ì • (ê¸°ë³¸ê°’: 9.6.0)
ARG PNPM_VERSION=10.16.0

# ğŸ”§ PNPM í™ˆ ë””ë ‰í† ë¦¬ë¥¼ ì „ì—­ bin ê²½ë¡œë¡œ ì„¤ì •
ENV PNPM_HOME=/usr/local/bin

# ğŸ“‹ Node.js Corepackì„ í™œì„±í™”í•˜ì—¬ PNPM íŒ¨í‚¤ì§€ ë§¤ë‹ˆì € ì„¤ì •
# - corepack enable: Node.js íŒ¨í‚¤ì§€ ë§¤ë‹ˆì € ê´€ë¦¬ ë„êµ¬ í™œì„±í™”
# - corepack prepare: íŠ¹ì • ë²„ì „ì˜ PNPM ì¤€ë¹„ ë° í™œì„±í™”
RUN corepack enable && corepack prepare pnpm@${PNPM_VERSION} --activate

# ğŸ› ï¸ Alpine Linux ì‹œìŠ¤í…œ ì¢…ì†ì„± ì„¤ì¹˜
# - libc6-compat: GNU libc í˜¸í™˜ì„± ë¼ì´ë¸ŒëŸ¬ë¦¬ (Node.js ë„¤ì´í‹°ë¸Œ ëª¨ë“ˆ í˜¸í™˜ì„±)
# - nginx: ì›¹ ì„œë²„ ë° ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œ
# - supervisor: í”„ë¡œì„¸ìŠ¤ ê´€ë¦¬ì (nginxì™€ node ë™ì‹œ ì‹¤í–‰)
# - apk ìºì‹œ ì •ë¦¬ë¡œ ì´ë¯¸ì§€ í¬ê¸° ìµœì í™”
RUN apk add --update --no-cache libc6-compat nginx supervisor && rm -rf /var/cache/apk/*

# ğŸ¯ ì „ì—­ ë„êµ¬ ì„¤ì¹˜
# - nest: NestJS CLI ë„êµ¬
# - turbo: Monorepo ë¹Œë“œ ì‹œìŠ¤í…œ ìµœì í™” ë„êµ¬
RUN pnpm add -g nest
RUN pnpm add -g turbo

# ğŸ“‚ ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
WORKDIR /app

# ============================================================================
# ğŸ” SETUP STAGE: ì¢…ì†ì„± ë¶„ì„ ë° í”„ë¡œì íŠ¸ êµ¬ì¡° ìµœì í™”
# ============================================================================
FROM base AS setup

# ğŸ“‹ ì „ì²´ í”„ë¡œì íŠ¸ íŒŒì¼ ë³µì‚¬
COPY . .

# ğŸ¯ Turboë¥¼ ì‚¬ìš©í•´ ì„œë²„ ì•±ë§Œì„ ìœ„í•œ ìµœì†Œí•œì˜ ì¢…ì†ì„± íŠ¸ë¦¬ ìƒì„±
# - --scope=server: ì„œë²„ ì•±ê³¼ ê´€ë ¨ëœ íŒ¨í‚¤ì§€ë§Œ ì¶”ì¶œ
# - --docker: Docker ìµœì í™”ëœ ì¶œë ¥ êµ¬ì¡° ìƒì„±
RUN turbo prune --scope=server --docker

# ============================================================================
# ğŸ­ BUILDER STAGE: ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ
# ============================================================================
FROM base AS builder

# ğŸ“‹ Git ë¬´ì‹œ íŒŒì¼ ë³µì‚¬ (ë¹Œë“œ ê³¼ì •ì—ì„œ í•„ìš”)
COPY .gitignore .gitignore

# ğŸ“‚ ì‘ì—… ë””ë ‰í† ë¦¬ ì¬ì„¤ì •
WORKDIR /app

# ğŸ“¦ Setup ë‹¨ê³„ì—ì„œ ìµœì í™”ëœ íŒŒì¼ êµ¬ì¡° ë³µì‚¬
# - /app/out/full/: Turbo pruneìœ¼ë¡œ ìƒì„±ëœ ìµœì í™”ëœ í”„ë¡œì íŠ¸ êµ¬ì¡°
COPY --from=setup /app/out/full/ ./ 

# ğŸš€ ì¢…ì†ì„± ì„¤ì¹˜ (ìºì‹œ ë§ˆìš´íŠ¸ë¡œ ì„±ëŠ¥ ìµœì í™”)
# - mount=type=cache: PNPM ìŠ¤í† ì–´ë¥¼ ìºì‹œë¡œ ë§ˆìš´íŠ¸í•˜ì—¬ ì¬ë¹Œë“œ ì‹œ ì†ë„ í–¥ìƒ
# - id=pnpm: ìºì‹œ ì‹ë³„ì
# - target=/pnpm/store: PNPM ìºì‹œ ì €ì¥ì†Œ ê²½ë¡œ
RUN --mount=type=cache,id=pnpm,target=/pnpm/store pnpm install

# ğŸ“‹ Turbo ì„¤ì • íŒŒì¼ ë³µì‚¬
COPY turbo.json turbo.json

# ğŸ“‚ ë£¨íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ë‹¤ì‹œ ì´ë™
WORKDIR /app

# ğŸ—ï¸ Turboë¥¼ ì‚¬ìš©í•œ í”„ë¡œì íŠ¸ ë¹Œë“œ
# - ëª¨ë“  ê´€ë ¨ íŒ¨í‚¤ì§€ì™€ ì¢…ì†ì„±ì„ ìµœì í™”ëœ ìˆœì„œë¡œ ë¹Œë“œ
RUN turbo build

# ============================================================================
# ğŸš€ PRODUCTION STAGE: ìš´ì˜ í™˜ê²½ ì»¨í…Œì´ë„ˆ
# ============================================================================
FROM node:24-alpine AS dev

# ğŸ› ï¸ Alpine Linuxì—ì„œ nginxì™€ supervisor ì„¤ì¹˜
RUN apk add --update --no-cache nginx supervisor && rm -rf /var/cache/apk/*

# ğŸ“‚ ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
WORKDIR /app

# ğŸ“¦ ë¹Œë“œ ë‹¨ê³„ì—ì„œ ì™„ì„±ëœ ì• í”Œë¦¬ì¼€ì´ì…˜ ë³µì‚¬
COPY --from=builder /app/ .

# ğŸ”§ nginx ì„¤ì • íŒŒì¼ ë³µì‚¬ (ì„œë²„ìš© ì„¤ì •ì„ í‘œì¤€ nginx.confë¡œ ë³µì‚¬)
COPY devops/nginx.server.config /etc/nginx/nginx.conf

# ğŸ“‹ supervisor ë””ë ‰í† ë¦¬ ìƒì„± ë° ì„¤ì • íŒŒì¼ ìƒì„±
RUN mkdir -p /etc/supervisor && \
    echo '[supervisord]' > /etc/supervisor/supervisord.conf && \
    echo 'nodaemon=true' >> /etc/supervisor/supervisord.conf && \
    echo 'user=root' >> /etc/supervisor/supervisord.conf && \
    echo '' >> /etc/supervisor/supervisord.conf && \
    echo '[program:nginx]' >> /etc/supervisor/supervisord.conf && \
    echo 'command=nginx -g "daemon off;"' >> /etc/supervisor/supervisord.conf && \
    echo 'autostart=true' >> /etc/supervisor/supervisord.conf && \
    echo 'autorestart=true' >> /etc/supervisor/supervisord.conf && \
    echo 'stdout_logfile=/dev/stdout' >> /etc/supervisor/supervisord.conf && \
    echo 'stdout_logfile_maxbytes=0' >> /etc/supervisor/supervisord.conf && \
    echo 'stderr_logfile=/dev/stderr' >> /etc/supervisor/supervisord.conf && \
    echo 'stderr_logfile_maxbytes=0' >> /etc/supervisor/supervisord.conf && \
    echo '' >> /etc/supervisor/supervisord.conf && \
    echo '[program:node-app]' >> /etc/supervisor/supervisord.conf && \
    echo 'command=node /app/apps/server/dist/main' >> /etc/supervisor/supervisord.conf && \
    echo 'directory=/app' >> /etc/supervisor/supervisord.conf && \
    echo 'autostart=true' >> /etc/supervisor/supervisord.conf && \
    echo 'autorestart=true' >> /etc/supervisor/supervisord.conf && \
    echo 'stdout_logfile=/dev/stdout' >> /etc/supervisor/supervisord.conf && \
    echo 'stdout_logfile_maxbytes=0' >> /etc/supervisor/supervisord.conf && \
    echo 'stderr_logfile=/dev/stderr' >> /etc/supervisor/supervisord.conf && \
    echo 'stderr_logfile_maxbytes=0' >> /etc/supervisor/supervisord.conf

# ğŸ”’ nginx ë””ë ‰í† ë¦¬ ê¶Œí•œ ì„¤ì •
RUN mkdir -p /var/log/nginx /var/cache/nginx /var/run && \
    chown -R nginx:nginx /var/log/nginx /var/cache/nginx

# ğŸŒ í¬íŠ¸ 80 (nginx), 3006 (node) ë…¸ì¶œ
EXPOSE 80 3006

# ğŸ‘¤ ë£¨íŠ¸ ì‚¬ìš©ìë¡œ ì‹¤í–‰
USER root

# ğŸ¯ supervisorë¥¼ í†µí•´ nginxì™€ node ì• í”Œë¦¬ì¼€ì´ì…˜ ë™ì‹œ ì‹¤í–‰
CMD ["/usr/bin/supervisord", "-c", "/etc/supervisor/supervisord.conf"]
