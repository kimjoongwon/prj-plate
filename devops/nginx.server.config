# 📋 이벤트 처리 설정 블록
# nginx의 연결 처리 방식과 워커 프로세스 동작을 정의
events {
    # 각 워커 프로세스가 동시에 처리할 수 있는 최대 연결 수
    # 높을수록 더 많은 동시 연결을 처리할 수 있지만 메모리 사용량 증가
    worker_connections 1024;
}

# 🌐 HTTP 서버 설정 블록
http {
    # 🎯 업스트림 서버 그룹 정의
    # 로드 밸런싱 및 백엔드 서버 관리를 위한 설정
    upstream backend {
        # NestJS 애플리케이션이 실행되는 서버와 포트
        # 127.0.0.1 = localhost, 3006 = APP_PORT 환경변수 값
        server 127.0.0.1:3006;
    }

    # 🖥️ 가상 호스트 서버 블록
    server {
        # HTTP 요청을 받을 포트 (표준 HTTP 포트)
        listen 80;
        
        # 이 서버 블록이 응답할 도메인명
        # localhost 또는 IP로 접근하는 요청을 처리
        server_name localhost;

        # 🔄 모든 요청을 백엔드 서버로 프록시
        # 루트 경로(/)로 들어오는 모든 요청을 NestJS 앱으로 전달
        location / {
            # 정의된 upstream backend 그룹으로 요청 전달
            proxy_pass http://backend;
            
            # HTTP/1.1 프로토콜 사용 (Keep-Alive 연결 지원)
            proxy_http_version 1.1;
            
            # 🔌 WebSocket 지원을 위한 헤더 설정
            # Upgrade 헤더: HTTP에서 WebSocket으로 프로토콜 업그레이드 요청 전달
            proxy_set_header Upgrade $http_upgrade;
            # Connection 헤더: 연결 유지 또는 업그레이드 요청 전달
            proxy_set_header Connection 'upgrade';
            
            # 🏷️ 원본 요청 정보를 백엔드에 전달하는 헤더들
            # Host: 클라이언트가 요청한 원본 호스트명 전달
            proxy_set_header Host $host;
            # X-Real-IP: 실제 클라이언트 IP 주소 전달 (프록시 체인에서 원본 IP 추적)
            proxy_set_header X-Real-IP $remote_addr;
            # X-Forwarded-For: 프록시 체인을 거쳐온 모든 클라이언트 IP 추가
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            # X-Forwarded-Proto: 원본 요청의 프로토콜(HTTP/HTTPS) 전달
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # 🚫 WebSocket 연결 시 캐시 우회
            # HTTP Upgrade 요청 시에는 캐싱하지 않도록 설정
            proxy_cache_bypass $http_upgrade;
        }

        # 📦 Gzip 압축 설정 - 대역폭 절약 및 로딩 속도 향상
        # 응답 데이터를 압축하여 전송 크기 줄이기
        gzip on;
        
        # Accept-Encoding 헤더에 따라 Vary 헤더 추가
        # 클라이언트가 압축을 지원하는지에 따라 다른 캐시 생성
        gzip_vary on;
        
        # 압축을 적용할 최소 파일 크기 (1KB)
        # 작은 파일은 압축 오버헤드가 더 클 수 있어 임계값 설정
        gzip_min_length 1024;
        
        # 압축을 적용할 MIME 타입 목록
        # 텍스트 기반 파일들만 압축 (이미지/바이너리 파일은 이미 압축됨)
        gzip_types text/plain text/css text/xml text/javascript application/javascript application/xml+rss application/json;
    }
}