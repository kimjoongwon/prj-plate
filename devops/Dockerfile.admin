# ============================================================================
# ğŸ—ï¸ BASE STAGE: ê¸°ë³¸ í™˜ê²½ ì„¤ì •
# ============================================================================
# Node.js 24 Alpine Linux ê¸°ë°˜ ì´ë¯¸ì§€ ì‚¬ìš© (ê²½ëŸ‰í™”ëœ ë¦¬ëˆ…ìŠ¤ ë°°í¬íŒ)
FROM node:24-alpine AS base

# ğŸ“¦ PNPM ë²„ì „ì„ ì¸ìë¡œ ë°›ì•„ì„œ ì„¤ì •
ARG PNPM_VERSION=10.16.0

# ğŸ”§ PNPM í™ˆ ë””ë ‰í† ë¦¬ë¥¼ ì „ì—­ bin ê²½ë¡œë¡œ ì„¤ì •
ENV PNPM_HOME=/usr/local/bin

# ğŸ“‹ Node.js Corepackì„ í™œì„±í™”í•˜ì—¬ PNPM íŒ¨í‚¤ì§€ ë§¤ë‹ˆì € ì„¤ì •
# - corepack enable: Node.js íŒ¨í‚¤ì§€ ë§¤ë‹ˆì € ê´€ë¦¬ ë„êµ¬ í™œì„±í™”
# - corepack prepare: íŠ¹ì • ë²„ì „ì˜ PNPM ì¤€ë¹„ ë° í™œì„±í™”
RUN corepack enable && corepack prepare pnpm@${PNPM_VERSION} --activate

# ğŸ› ï¸ Alpine Linux ì‹œìŠ¤í…œ ì¢…ì†ì„± ì„¤ì¹˜
# - libc6-compat: GNU libc í˜¸í™˜ì„± ë¼ì´ë¸ŒëŸ¬ë¦¬ (Node.js ë„¤ì´í‹°ë¸Œ ëª¨ë“ˆ í˜¸í™˜ì„±)
# - apk ìºì‹œ ì •ë¦¬ë¡œ ì´ë¯¸ì§€ í¬ê¸° ìµœì í™”
RUN apk add --update --no-cache libc6-compat && rm -rf /var/cache/apk/*

# ğŸ¯ ì „ì—­ ë„êµ¬ ì„¤ì¹˜
# - turbo: Monorepo ë¹Œë“œ ì‹œìŠ¤í…œ ìµœì í™” ë„êµ¬ (ê´€ë¦¬ì ì•± ë¹Œë“œìš©)
RUN pnpm add -g turbo

# ğŸ“‚ ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
WORKDIR /app

# ============================================================================
# ğŸ” SETUP STAGE: ì¢…ì†ì„± ë¶„ì„ ë° í”„ë¡œì íŠ¸ êµ¬ì¡° ìµœì í™”
# ============================================================================
FROM base AS setup

# ğŸ“‹ ì „ì²´ í”„ë¡œì íŠ¸ íŒŒì¼ ë³µì‚¬
COPY . .

# ğŸ¯ Turboë¥¼ ì‚¬ìš©í•´ ê´€ë¦¬ì ì•±ë§Œì„ ìœ„í•œ ìµœì†Œí•œì˜ ì¢…ì†ì„± íŠ¸ë¦¬ ìƒì„±
# - --scope=admin: ê´€ë¦¬ì ì•±ê³¼ ê´€ë ¨ëœ íŒ¨í‚¤ì§€ë§Œ ì¶”ì¶œ
# - --docker: Docker ìµœì í™”ëœ ì¶œë ¥ êµ¬ì¡° ìƒì„±
RUN turbo prune --scope=admin --docker

# ============================================================================
# ğŸ­ BUILDER STAGE: Next.js ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ
# ============================================================================
FROM base AS builder

# ğŸ“‚ ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
WORKDIR /app

# ğŸ“¦ Setup ë‹¨ê³„ì—ì„œ ìµœì í™”ëœ íŒŒì¼ êµ¬ì¡° ë³µì‚¬
# - /app/out/full/: Turbo pruneìœ¼ë¡œ ìƒì„±ëœ ìµœì í™”ëœ í”„ë¡œì íŠ¸ êµ¬ì¡°
COPY --from=setup /app/out/full/ ./

# ğŸš€ ì¢…ì†ì„± ì„¤ì¹˜ (ìºì‹œ ë§ˆìš´íŠ¸ë¡œ ì„±ëŠ¥ ìµœì í™”)
# - mount=type=cache: PNPM ìŠ¤í† ì–´ë¥¼ ìºì‹œë¡œ ë§ˆìš´íŠ¸í•˜ì—¬ ì¬ë¹Œë“œ ì‹œ ì†ë„ í–¥ìƒ
# - id=pnpm: ìºì‹œ ì‹ë³„ì
# - target=/pnpm/store: PNPM ìºì‹œ ì €ì¥ì†Œ ê²½ë¡œ
RUN --mount=type=cache,id=pnpm,target=/pnpm/store pnpm install

# ğŸ“‹ Turbo ì„¤ì • íŒŒì¼ ë³µì‚¬
COPY turbo.json turbo.json

# ğŸ—ï¸ ê´€ë¦¬ì ì•± ë¹Œë“œ ì‹¤í–‰ (Next.js standalone ëª¨ë“œ)
RUN turbo build

# ============================================================================
# ğŸš€ PRODUCTION STAGE: Next.js ì„œë²„ ì‹¤í–‰
# ============================================================================
FROM node:24-alpine AS runner

# ğŸ“‚ ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
WORKDIR /app

# ğŸ”’ ë³´ì•ˆì„ ìœ„í•œ non-root ì‚¬ìš©ì ì„¤ì •
RUN addgroup --system --gid 1001 nodejs && \
    adduser --system --uid 1001 nextjs

# ğŸ“¦ Next.js standalone ë¹Œë“œ ê²°ê³¼ë¬¼ ë³µì‚¬
# - standalone: ìµœì†Œí™”ëœ Node.js ì„œë²„
COPY --from=builder --chown=nextjs:nodejs /app/apps/admin/.next/standalone ./

# ğŸ“¦ ì •ì  íŒŒì¼ ë³µì‚¬
# - static: CSS, JS, ì´ë¯¸ì§€ ë“± ì •ì  ìì‚°
COPY --from=builder --chown=nextjs:nodejs /app/apps/admin/.next/static ./apps/admin/.next/static

# ğŸ“¦ public í´ë” ë³µì‚¬ (ì¡´ì¬í•˜ëŠ” ê²½ìš°)
COPY --from=builder --chown=nextjs:nodejs /app/apps/admin/public ./apps/admin/public

# ğŸ”§ í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
ENV NODE_ENV=production
ENV PORT=3000
ENV HOSTNAME="0.0.0.0"

# ğŸ‘¤ non-root ì‚¬ìš©ìë¡œ ì „í™˜
USER nextjs

# ğŸŒ í¬íŠ¸ 3000 ë…¸ì¶œ
EXPOSE 3000

# ğŸ¯ Next.js ì„œë²„ ì‹¤í–‰
CMD ["node", "apps/admin/server.js"]
